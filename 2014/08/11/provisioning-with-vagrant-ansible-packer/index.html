<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Provisioning with Vagrant, Ansible, and Packer - Dan's Random Bits</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://danlmarmot.github.io/blog/2014/08/11/provisioning-with-vagrant-ansible-packer/">

        <meta name="author" content="Dan McKean" />
        <meta name="keywords" content="ansible,vagrant,packer" />
        <meta name="description" content="One big issue in using servers on cloud providers suck as Amazon Web Services, Rackspace, and Google Compute Engine is dealing with their provisioning and deployment--in other words, how to build them out to begin with. Sure, you can write lots of Bash scripts, invest in Puppet and Chef training ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://danlmarmot.github.io/blog/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://danlmarmot.github.io/blog/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://danlmarmot.github.io/blog/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://danlmarmot.github.io/blog/theme/css/style.css" type="text/css"/>

        <link href="https://danlmarmot.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Dan's Random Bits ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://danlmarmot.github.io/blog/" class="navbar-brand">
Dan's Random Bits            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="https://danlmarmot.github.io/blog/category/tech.html">Tech</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://danlmarmot.github.io/blog/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://danlmarmot.github.io/blog/2014/08/11/provisioning-with-vagrant-ansible-packer/"
                       rel="bookmark"
                       title="Permalink to Provisioning with Vagrant, Ansible, and Packer">
                        Provisioning with Vagrant, Ansible, and Packer
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-08-11T18:55:00-07:00"> Mon 11 August 2014</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="https://danlmarmot.github.io/blog/tag/ansible.html">ansible</a>
        /
	<a href="https://danlmarmot.github.io/blog/tag/vagrant.html">vagrant</a>
        /
	<a href="https://danlmarmot.github.io/blog/tag/packer.html">packer</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>One big issue in using servers on cloud providers suck as Amazon Web Services, Rackspace, and Google Compute Engine is dealing with their provisioning and deployment--in other words, how to build them out to begin with.
Sure, you can write lots of Bash scripts, invest in Puppet and Chef training and infrastructure, and script the whole thing out.  I've tried some of those, but generally found them real burdensome and in general they hinder productivity, not improve it.</p>
<p>Ansible is a more recent utility that aims to be simpler to use by developers, and I've found it better integrates with my workflows, and is much less difficult to maintain. Ansible works strictly over SSH and doesn't require you to manage any additional infrastructure such as a server--and I like the fact that you don't have to install agents on the machines you manage, so you don't have the tricky problem of bootstrapping with cloud-init.</p>
<p>This lengthy blog post focuses on using Ansible with Vagrant and Packer, so that we can automate the provisioning of virtual machines for development, QA, CI, and production.  For development, we'll be using Vagrant, and for cloud deployments we'll be using Packer to create machine images for Amazon.</p>
<h2>A few terms first</h2>
<p>To get on the same page, here's some terms and conventions I'm using in this article.</p>
<h3>Provisioning</h3>
<p>Provisioning is the initial configuration and setup of a machine instance, including installation of all pre-requisite packages and software, creation of user and service accounts, and configuration. It's what you have to do before you install any of your applications. Provisioning also generally includes common monitoring tools and utilities to make sure the machine can update its health status or emit metrics to the operations infrastructure.</p>
<h3>Deployment</h3>
<p>Deployment is simply putting one or more applications on the machine. After provisioning, an initial deployment is typically done.  An image is often created as well, before or after the deployment.</p>
<h3>Environment</h3>
<p>An environment is a collection of services and machines that depend on each other. Think of the term "environment" as meaning "production environment" or "staging environment" or "local environment". Different development teams use different terms.</p>
<h3>Machine Image</h3>
<p>Machine images are snapshots of machine, usually with all software and dependencies installed, and perhaps an initial deployment of up-to-date code. They are provider-specific: Amazon machine images aren't the same as VMware machine images or Digital Ocean machine images, and often have to be created with provider-specific tools.</p>
<h2>Prep Work</h2>
<p>This document is really meant to be used by Mac users, and in particular folks running MacOS 10.9. Vagrant/Packer/Ansible are all oriented towards various Unix flavors, and don't fully support Windows. Other operating systems related to Linux are supported, such as Mac OS X, Ubuntu, Centos, Fedora, AmazonLinux, and versions of FreeBSD.  But I'm just using my Mac.</p>
<h2>Step 0 - Clone the Github repository</h2>
<p>For this demo, the code's on Github.  You can get it with this command</p>
<p><code>git clone https://github.com/danlmarmot/demo-ansible-vagrant-packer</code></p>
<p>Clone it onto your local Mac--if you need help at this point, see the Github help pages.</p>
<h2>Step 1 - Install Vagrant and VirtualBox</h2>
<p>With the source code checked out, change into the checked out git repo with</p>
<p><code>cd demo-ansible-vagrant-packer/</code></p>
<p>We will not be changing out of this directory, so you're good at this point.</p>
<h3>Install VirtualBox and Vagrant</h3>
<p>VirtualBox is available at https://www.virtualbox.org/wiki/Downloads.</p>
<p>Vagrant is at https://www.vagrantup.com/downloads.html</p>
<p>Once you've installed, enter these commands to verify your installation
At a command prompt type the following and ensure there aren't any errors.</p>
<p><code>vagrant -v</code></p>
<h3>Initialize Vagrant</h3>
<p>Look at the Vagrantfile at the root of your checkout. It should look like this if you've checked it out from Git -- if you haven't, make it look like this:</p>
<div class="highlight"><pre><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/trusty64&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.111.222&quot;</span>
<span class="k">end</span>
</pre></div>


<p>This just says launch an Ubuntu Trusty 64-bit image (which is Ubuntu 14.04 LTS, released in April 2014).</p>
<p><em>A side note: Vagrantfiles are written in Ruby syntax--if you know Ruby, you can add additional logic to them.</em></p>
<p>Launch the VM with 'vagrant up':</p>
<p><code>vagrant up</code></p>
<p>You should see:</p>
<div class="highlight"><pre>Bringing machine &#39;default&#39; up with &#39;virtualbox&#39; provider...
==&gt; default: Box &#39;ubuntu/trusty64&#39; could not be found. Attempting to find and
install...
    default: Box Provider: virtualbox
    default: Box Version: &gt;= 0
==&gt; default: Loading metadata for box &#39;ubuntu/trusty64&#39;
    default: URL: https://vagrantcloud.com/ubuntu/trusty64
==&gt; default: Adding box &#39;ubuntu/trusty64&#39; (v14.04) for provider: virtualbox
    default: Downloading:
https://vagrantcloud.com/ubuntu/trusty64/version/1/provider/virtualbox.box
    default: Progress: 33% (Rate: 1274k/s, Estimated time remaining: 0:01:03)
Connect with SSH to the Vagrant VM:
vagrant ssh
Welcome to Ubuntu 14.04 LTS (GNU/Linux 3.13.0-24-generic x86_64)
</pre></div>


<p>Now you've got a Vagrant-managed VM to work with! Exit the SSH prompt with:</p>
<p><code>exit</code></p>
<h3>Step 2 - Add Ansible to manage the Vagrant VM</h3>
<p>We'll be using Ansible, which works over SSH to configure the VM, reading from YAML files to drive the configuration. Ansible doesn't require any software to be installed on the VM (it's agentless).  I put my Ansible YAML files are checked into source control alongside the Vagrantfile into a directory called provision.</p>
<p>This Ansible YAML document describing the steps to perform is called a playbook. Vagrant knows how to use Ansible to provision the instance, with a reference to that YAML file in the the Vagrantfile.</p>
<p>To make sure things all work, we're going to do a really simple task: create the directory /tmp/foo on the Vagrant VMVM.</p>
<h4>Resources</h4>
<p>There are a lot of resources on the web that describe these steps.  These are the ones I found handy are handy when you get done with walking through this guide:</p>
<p><a href="http://docs.ansible.com/guide_vagrant.html">http://docs.ansible.com/guide_vagrant.html</a></p>
<p><a href="http://docs.vagrantup.com/v2/provisioning/ansible.html">http://docs.vagrantup.com/v2/provisioning/ansible.html</a></p>
<p><a href="https://www.digitalocean.com/community/articles/how-to-create-ansible-playbooks-to-automate-system-configuration-on-ubuntu">https://www.digitalocean.com/community/articles/how-to-create-ansible-playbooks-to-automate-system-configuration-on-ubuntu</a></p>
<h3>Install Ansible</h3>
<p>First, we need to install Ansible, which is a Python package.  Mac OS X 10.9 has Python 2.7 pre-installed.</p>
<p>We will install Ansible globally, and not in a virtual environment–it's not a heavy installation, and doesn't require any other software dependencies apart from a few other Python packages. One of these Python packages for SSH will need to be compiled with XCode, so you'll need the XCode (available from the App Store) and the XCode command line tools installed.</p>
<p>Run these two commands to install Ansible. The first ensures pip is installed (the standard Python package manager), then the next installs or upgrades Ansible if you've previously installed it.</p>
<p><code>sudo easy_install pip; sudo pip install ansible --upgrade</code></p>
<h3>An Important XCode Gotcha</h3>
<p>On MacOS X with some versions of XCode, if you get an error about "-Wno-error=unused-command-line-argument-hard-error-in-future" you can supress the warning by installing Ansible with this ugly command.</p>
<p><code>sudo ARCHFLAGS=-Wno-error=unused-command-line-argument-hard-error-in-future pip install ansible --upgrade</code></p>
<p>Side note: This is a tedious warning, and if you install other Python packages or Ruby gems that require compiling you'll hit this over and over. You can add this your your ~/.bash_profile on your Mac to get around this.</p>
<p><code>echo export ARCHFLAGS=-Wno-error=unused-command-line-argument-hard-error-in-future &gt;&gt;
~/.bash_profile; source ~/.bash_profile</code></p>
<h3>Update the source code to step 2</h3>
<p><code>git checkout -f tags/step2</code></p>
<h3>Add an Ansible playbook</h3>
<p>This playbook will be at the top of our directory, and we'll name it "playbook.yml".</p>
<p>You can write this out yourself, or just look at what Git checked out.</p>
<div class="highlight"><pre>---
- name: Verify ansible works
  hosts: all
  user: vagrant
  sudo: yes
  gather_facts: false
  tasks:
    - name: Create /tmp/foo
      file: path=/tmp/foo state=directory
</pre></div>


<h3>Update the Vagrantfile with Ansible provisioning</h3>
<p>Now let's add the Ansible provisioner to the Vagrantfile--that's the file that tells Vagrant to use Ansible to build out the VM. That entire file should look like this.</p>
<div class="highlight"><pre><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/trusty64&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.111.222&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
    <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
    <span class="n">ansible</span><span class="o">.</span><span class="n">extra_vars</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">ansible_ssh_user</span><span class="p">:</span> <span class="s1">&#39;vagrant&#39;</span> <span class="p">}</span>
    <span class="n">ansible</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;vv&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h3>Provision the VM</h3>
<p>This is where the magic happens. Run it from a command prompt with</p>
<p><code>vagrant provision</code></p>
<p>If everything's setup correctly, you'll see output similar to this:</p>
<div class="highlight"><pre>==&gt; default: Running provisioner: ansible...
ANSIBLE_FORCE_COLOR=true ANSIBLE_HOST_KEY_CHECKING=false PYTHONUNBUFFERED=1 ansible-playbook --private-key=/Users/Marmot/.vagrant.d/insecure_private_key --user=vagrant --limit=&#39;default&#39; --inventory-file=/Users/Marmot/dev/bb-danlmarmot/demo-ansible-vagrant-packer/.vagrant/provisioners/ansible/inventory --extra-vars={&quot;ansible_ssh_user&quot;:&quot;vagrant&quot;} -vv playbook.yml

PLAY [Verify ansible works] ***************************************************

TASK: [Create /tmp/foo] *******************************************************
&lt;127.0.0.1&gt; REMOTE_MODULE file path=/tmp/foo state=directory
changed: [default] =&gt; {&quot;changed&quot;: true, &quot;gid&quot;: 0, &quot;group&quot;: &quot;root&quot;, &quot;mode&quot;: &quot;0755&quot;, &quot;owner&quot;: &quot;root&quot;, &quot;path&quot;: &quot;/tmp/foo&quot;, &quot;size&quot;: 4096, &quot;state&quot;: &quot;directory&quot;, &quot;uid&quot;: 0}

PLAY RECAP ********************************************************************
default                    : ok=1    changed=1    unreachable=0    failed=0
</pre></div>


<p>At this point Ansible and Vagrant are working with each other. That's a big win, and now we can start doing more complicated things.</p>
<h4>Troubleshooting "vagrant provision"</h4>
<h5>Error: "VM not created"</h5>
<p>If you get a message similar to this:</p>
<div class="highlight"><pre>vagrant provision
==&gt; default: VM not created. Moving on...
</pre></div>


<p>Fix it by:</p>
<p><code>vagrant up</code></p>
<p>This is just simply because the Vagrant VM isn't running, so it can't receive the <code>vagrant provision</code> command</p>
<h3>Verify that the provisioning worked</h3>
<p>Now let's verify this worked by SSH-ing into the Vagrant VM.</p>
<div class="highlight"><pre>vagrant ssh
vagrant@vagrant-ubuntu-trusty-64:~$ ls /tmp
foo
</pre></div>


<p>Exit out of the SSH session</p>
<div class="highlight"><pre>vagrant@vagrant-ubuntu-trusty-64:~$ exit
</pre></div>


<h3>Destroy the Vagrant VM</h3>
<p>We won't be using this simple VM in the following steps--it was good to verify that Ansible is setup correctly--so we'll destroy it.</p>
<div class="highlight"><pre>vagrant destroy
    default: Are you sure you want to destroy the &#39;default&#39; VM? [y/N] y
==&gt; default: Forcing shutdown of VM...
==&gt; default: Destroying VM and associated drives...
==&gt; default: Running cleanup tasks for &#39;ansible&#39; provisioner...
</pre></div>


<h2>Step 3 - Using Ansible to provision nginx</h2>
<p>Ansible can be used for quite a bit more than create directories from a single playbook file, and can manipulate a fair number of resources from system settings (users, groups, cronjobs, package repositories) to applications (Apache httpd, ntpd) to cloud assets (AWS EC2 instances, OpenStack storage).  For a full list visit http://docs.ansible.com/modules_by_category.html</p>
<p>This is also when we'll start using more typical Ansible conventions.</p>
<h3>Resources</h3>
<p><a href="http://docs.ansible.com/playbooks_best_practices.html">http://docs.ansible.com/playbooks_best_practices.html</a> has a good walk-through of a non-trivial site layout involving a few different types of servers in a few different server locations.</p>
<h3>Update source</h3>
<p>In that same directory, update the source code to step 3</p>
<p><code>git checkout -f tags/step3</code></p>
<h3>Create the provisioning directory for nginx</h3>
<p>Ansible has a recommended convention for laying out a directory. The docs are here, <a href="http://docs.ansible.com/playbooks_best_practices.html">http://docs.ansible.com/playbooks_best_practices.html</a>, and they're a good walk-through of a non-trivial layout.</p>
<p>The following steps show what you'll have to do manually--if you haven't checked out step3 from git, do these manually. First, create a directory to hold our Ansible provisioning files.</p>
<p><code>mkdir provision</code></p>
<p>Create the nginx role in Ansible</p>
<p>Now, add an Ansible role to install nginx:</p>
<p><code>ansible-galaxy init roles/nginx</code></p>
<p>And let's edit some files. Note that each file should start with the three dashes, which indicates it's a YAML file.  (Ansible isn't all that picky on those three dashes, though) The entire contents of all the file are listed below:</p>
<h4>roles/nginx/tasks/main.yml</h4>
<p>This is the main list of tasks that Ansible performs when it's provisioning the nginx role. These tasks are performed sequentially, there's no "convergence" phase at runtime as there are in other tools.</p>
<div class="highlight"><pre>---
 - name: add nginx ppa repository
   apt_repository: repo=&#39;ppa:nginx/stable&#39;

 - name: install nginx
   apt: pkg=nginx state=installed

 - name: remove default site
   file: path=/etc/nginx/sites-enabled/default state=absent
   notify: restart nginx  

 - name: add our nginx.conf
   copy: src=nginx.conf dest=/etc/nginx/nginx.conf owner=root group=root mode=644
   notify: restart nginx  

 - name: add static directory
   file: path=/opt/static state=directory

 - name: add static site index.htm file
   copy: src=index.html dest=/opt/static/index.html owner=root group=root mode=644
   notify: restart nginx  

 - name: add nginx config file for static site
   copy: src=static.conf dest=/etc/nginx/conf.d/static.conf owner=root group=root mode=644
   notify: restart nginx  

 - name: start nginx
   service: name=nginx state=started
</pre></div>


<h4>nginx/tasks/handlers.yml</h4>
<p>Handlers are actions that are triggered when task does something.  With this nginx example, we'll want to restart nginx if we change the config files for nginx or the static site we're serving.</p>
<p>We have two handlers to do this.  The 'restart nginx' handler (which is called whenever a file changes through the task list above), and the 'verify nginx' handler to make sure nginx still works. The first 'restart nginx' handler calls the second handler with the notify statement.</p>
<p>That second handler just performs a "curl" command to make sure nginx is working.</p>
<div class="highlight"><pre>---
 - name: restart nginx
   service: name=nginx state=restarted
   notify: verify nginx

 - name: verify nginx
   shell: curl 127.0.0.1:8080
</pre></div>


<h4>roles/nginx/files/nginx.conf</h4>
<p>The nginx.conf file.  This is just a plain text file.  Ansible supports templates, but we're not using them in this walk-through.</p>
<div class="highlight"><pre>user www-data;
worker_processes 4;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    include /etc/nginx/conf.d/*.conf;
}
</pre></div>


<h4>roles/nginx/files/static.conf</h4>
<p>This text file just says where the static files live. We're putting them in /opt/static (many people put them in somewhere in /var, but I prefer to serve sites and web applications out of /opt/*)</p>
<div class="highlight"><pre>server {
    listen 8080;
    location / {
        root /opt/static;
        index index.html index.htm;
    }
}
</pre></div>


<h4>roles/nginx/files/index.html</h4>
<p>A static webpage that's served by nginx.</p>
<div class="highlight"><pre> &lt;html&gt;
 &lt;h2&gt;Hey nginx works!&lt;/h2&gt;
 &lt;/html&gt;
</pre></div>


<h4>webserver.yml</h4>
<p>This is an Ansible playbook to build out a webserver in our Vagrant environment.</p>
<div class="highlight"><pre>---
# file: webserver.yml
- hosts: all
  user: vagrant
  sudo: yes
  gather_facts: false
  roles:
    - nginx
</pre></div>


<h4>site.yml</h4>
<p>This describes the site.  There's just the one server type in there now.</p>
<div class="highlight"><pre>---
# file: site.yml
- include: webserver.yml
</pre></div>


<h3>A bit of explanation--how Ansible describes the site</h3>
<p>Now that you've done all that... what's all that mean?</p>
<p>With Ansible, the overall site is typically described by site.yml. It's a file that describes the entire site, and often it's pretty short and just includes other files, usually instances/servers/boxes by what they do, such as "web server" or "database server".</p>
<p>With Ansible terminology the term "role" refers to a fairly specific package or software component, like nginx or MySQL.</p>
<p>Ansible ends up having a tree of site components:</p>
<ul>
<li>
<p>The overall site in site.yml. This lists all the server types like "web_server" or "database_server". Sites can also be described by location, such as "oregon_servers" or "dublin_servers"</p>
</li>
<li>
<p>Server classes defined in <server>.yml file. This defines what roles are applied to each server type. Web servers might get nginx; database servers might get Postgres.</p>
</li>
<li>
<p>Roles in a <rolename> directory. Roles are encapuslated components, like redis or Apache web server, or a custom Java app in a Tomcat container.  The role directory has subdirectories inside where Ansible knows where to look, and the ones we use here are "files", "handlers", and "tasks".</p>
</li>
</ul>
<h3>Update the Vagrantfile</h3>
<p>We'll update the Vagrantfile to point to the new playbook, and refactor it a bit so it's easier to add new server types.</p>
<p>We'll also expose port 8080, so we can open up a web browser on our Mac to see nginx serving pages.</p>
<div class="highlight"><pre><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;webserver&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">webserver</span><span class="o">|</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/trusty64&quot;</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.111.222&quot;</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
    <span class="n">webserver</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">extra_vars</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">ansible_ssh_user</span><span class="p">:</span> <span class="s1">&#39;vagrant&#39;</span> <span class="p">}</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="s2">&quot;vv&quot;</span>
      <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;webserver.yml&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Launch this new Vagrant instance with</p>
<p><code>vagrant up webserver</code></p>
<p>Ansible will startup the new instance, install nginx and our single-page static site, and verify it's working with the curl command--look in the console output for the HTML.</p>
<h3>Verify</h3>
<p>You should also verify this works from your Mac--just visit <a href="http://localhost:8080">http://localhost:8080</a>, and you should see the "Hey nginx works!"</p>
<h3>Reprovisioning</h3>
<p>When you're developing with Ansible and Vagrant, you'll be tweaking your playbooks and task lists and files over and over, and you'll need a way to quickly rerun your work.  It takes a fairly long time to reimport a virtual machine from scratch, but Vagrant can reprovision your box with a simple command.</p>
<p>Let's try that now: edit the index.html file inside roles/nginx/files/index.html to say "Heyyyyy nginx works", and save the file away.</p>
<p>Now, rerun the provisioning on your Vagrant VM with</p>
<p><code>vagrant provision</code></p>
<p>You'll see that the index.htm file is changed:</p>
<div class="highlight"><pre>TASK: [nginx | add static site index.htm file] ********************************
changed: [webserver] =&gt; {&quot;changed&quot;: true, &quot;dest&quot;: &quot;/opt/static/index.html&quot;, &quot;gid&quot;: 0, &quot;group&quot;: &quot;root&quot;, &quot;md5sum&quot;: &quot;02f40bd936f4d308a679c0fa636e317d&quot;, &quot;mode&quot;: &quot;0644&quot;, &quot;owner&quot;: &quot;root&quot;, &quot;size&quot;: 46, &quot;src&quot;: &quot;/home/vagrant/.ansible/tmp/ansible-tmp-1407855909.5-223798276574238/source&quot;, &quot;state&quot;: &quot;file&quot;, &quot;uid&quot;: 0}
</pre></div>


<p>Because there is a notification handler on that file, nginx will be restarted and verified with curl:</p>
<div class="highlight"><pre>NOTIFIED: [nginx | restart nginx] *********************************************
&lt;127.0.0.1&gt; REMOTE_MODULE service name=nginx state=restarted
changed: [webserver] =&gt; {&quot;changed&quot;: true, &quot;name&quot;: &quot;nginx&quot;, &quot;state&quot;: &quot;started&quot;}

NOTIFIED: [nginx | verify nginx] **********************************************
&lt;127.0.0.1&gt; REMOTE_MODULE command curl 127.0.0.1:8080 #USE_SHELL
changed: [webserver] =&gt; {&quot;changed&quot;: true, &quot;cmd&quot;: &quot;curl 127.0.0.1:8080 &quot;, &quot;delta&quot;: &quot;0:00:00.009759&quot;, &quot;end&quot;: &quot;2014-08-12 15:07:03.461307&quot;, &quot;rc&quot;: 0, &quot;start&quot;: &quot;2014-08-12 15:07:03.451548&quot;, &quot;stderr&quot;: &quot;  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\r  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r100    44  100    44    0     0  17908      0 --:--:-- --:--:-- --:--:-- 22000&quot;, &quot;stdout&quot;: &quot;&lt;html&gt;\n&lt;h2&gt;Heyyyyy nginx works!!&lt;/h2&gt;\n&lt;/html&gt;&quot;}
</pre></div>


<p>You can (and should!) verify from your Mac's web browser by visiting <a href="http://localhost:8080">http://localhost:8080</a></p>
<p>d</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'dansrandombits'; // required: replace example with your forum shortname

                    var disqus_identifier = 'provisioning-with-vagrant-ansible-packer';
                var disqus_url = 'https://danlmarmot.github.io/blog/2014/08/11/provisioning-with-vagrant-ansible-packer/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">



            <li class="list-group-item"><a href="https://danlmarmot.github.io/blog/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                </ul>
            </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Dan McKean
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://danlmarmot.github.io/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://danlmarmot.github.io/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://danlmarmot.github.io/blog/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'dansrandombits'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
</body>
</html>