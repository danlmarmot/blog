<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Dan's Random Bits</title><link href="https://danlmarmot.github.io/blog/" rel="alternate"></link><link href="https://danlmarmot.github.io/blog/feeds/all.atom.xml" rel="self"></link><id>https://danlmarmot.github.io/blog/</id><updated>2014-10-23T00:00:00-07:00</updated><entry><title>Passing AWS Credentials to Vagrant in Ansible</title><link href="https://danlmarmot.github.io/blog/2014/10/23/aws-creds-to-vagrant-with-ansible/" rel="alternate"></link><updated>2014-10-23T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-10-23:blog/2014/10/23/aws-creds-to-vagrant-with-ansible/</id><summary type="html">&lt;p&gt;I needed my Vagrant instance to have AWS credentials to access an S3 bucket, but didn't want to hardcode them anywhere.  I simple wanted to pass the values of the environment variables to Vagrant, and have it use those.&lt;/p&gt;
&lt;p&gt;Since I was going to use Boto to get at that S3 bucket, I figured I just needed a way to set the variables in /etc/boto.conf on the Vagrant instance.&lt;/p&gt;
&lt;h3&gt;The Vagrantfile&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;VAGRANTFILE_API_VERSION = &amp;quot;2&amp;quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.define &amp;quot;web&amp;quot; do |web|
    web.vm.box = &amp;quot;ubuntu/trusty64&amp;quot;
    web.vm.provision &amp;quot;ansible&amp;quot; do |ansible|
      ansible.extra_vars = &amp;quot;@group_vars/vagrant&amp;quot;
      ansible.groups = {
        &amp;quot;vagrant&amp;quot; =&amp;gt; [&amp;quot;web&amp;quot;]
      }     
      ansible.playbook = &amp;quot;web-vagrant.yml&amp;quot;
    end
  end

end
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible group variables&lt;/h3&gt;
&lt;p&gt;The variables for Ansible are defined in group_vars/vagrant, which pulls them in from the two environment variables set on my Mac.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;group_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;
&lt;span class="n"&gt;ansible_ssh_user&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;

&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;AWS&lt;/span&gt; &lt;span class="n"&gt;keys&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;are&lt;/span&gt; &lt;span class="n"&gt;read&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="n"&gt;and&lt;/span&gt; &lt;span class="n"&gt;passed&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;VM&lt;/span&gt;
&lt;span class="n"&gt;aws_access_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_ACCESS_KEY_ID&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;aws_secret_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_SECRET_ACCESS_KEY&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible playbook&lt;/h3&gt;
&lt;p&gt;The playbook at web-vagrant.yml that defines Anisble tasks has this section in it.  Note it doesn't have:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;- name: Copy AWS creds from Vagrant host to Vagrant VM&lt;/span&gt;
&lt;span class="x"&gt;  hosts: all&lt;/span&gt;
&lt;span class="x"&gt;  user: &amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;ansible_ssh_user&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="x"&gt;  sudo: yes&lt;/span&gt;
&lt;span class="x"&gt;  gather_facts: false&lt;/span&gt;

&lt;span class="x"&gt;  tasks:&lt;/span&gt;
&lt;span class="x"&gt;  - name: Create the boto config file&lt;/span&gt;
&lt;span class="x"&gt;    template: &amp;gt;&lt;/span&gt;
&lt;span class="x"&gt;      src=vagrant/templates/boto.cfg.j2&lt;/span&gt;
&lt;span class="x"&gt;      dest=/etc/boto.cfg&lt;/span&gt;
&lt;span class="x"&gt;    when: group_name == &amp;quot;vagrant&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The boto template&lt;/h3&gt;
&lt;p&gt;And that boto template is just this small file, placed in vagrant/templates/boto.cfg.j2&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;[Credentials]&lt;/span&gt;
&lt;span class="na"&gt;aws_access_key_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_access_key }}&lt;/span&gt;
&lt;span class="na"&gt;aws_secret_access_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_secret_key }}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Testing this out&lt;/h2&gt;
&lt;p&gt;With Ansible, Vagrant, and Virtualbox installled, create these four files and put them in their correct places.  The directory structure should look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;.
├── Vagrantfile
├── group_vars
│   └── vagrant
├── vagrant
│   └── templates
│       └── boto.cfg.j2
└── web-vagrant.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Open a command prompt, and type these commands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant up
vagrant ssh
cat /etc/boto.cfg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The AWS keys from your Mac should be now inserted into boto.cfg.&lt;/p&gt;
&lt;p&gt;To reprovision the Vagrant box, use "vagrant provision" to rerun the Ansible playbook.&lt;/p&gt;
&lt;p&gt;When you're done, dispose of the Vagrant VM with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant destroy
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Going further&lt;/h2&gt;
&lt;p&gt;You could also do the same to create a config file for the &lt;a href="http://aws.amazon.com/cli/"&gt;AWS CLI tool&lt;/a&gt; if you're looking for something at the command line&lt;/p&gt;
&lt;p&gt;I didn't need this--in production, Boto will use the credentials taken from the instance's IAM role that it was launched with.&lt;/p&gt;</summary><category term="ansible"></category><category term="aws"></category></entry><entry><title>Passing AWS Credentials to Vagrant in Ansible</title><link href="https://danlmarmot.github.io/blog/2014/10/23/aws-creds-to-vagrant-with-ansible/" rel="alternate"></link><updated>2014-10-23T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-10-23:blog/2014/10/23/aws-creds-to-vagrant-with-ansible/</id><summary type="html">&lt;p&gt;I needed my Vagrant instance to have AWS credentials to access an S3 bucket, but didn't want to hardcode them anywhere.  I simple wanted to pass the values of the environment variables to Vagrant, and have it use those.&lt;/p&gt;
&lt;p&gt;Since I was going to use Boto to get at that S3 bucket, I figured I just needed a way to set the variables in /etc/boto.conf on the Vagrant instance.&lt;/p&gt;
&lt;h3&gt;The Vagrantfile&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;VAGRANTFILE_API_VERSION = &amp;quot;2&amp;quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.define &amp;quot;web&amp;quot; do |web|
    web.vm.box = &amp;quot;ubuntu/trusty64&amp;quot;
    web.vm.provision &amp;quot;ansible&amp;quot; do |ansible|
      ansible.extra_vars = &amp;quot;@group_vars/vagrant&amp;quot;
      ansible.groups = {
        &amp;quot;vagrant&amp;quot; =&amp;gt; [&amp;quot;web&amp;quot;]
      }     
      ansible.playbook = &amp;quot;web-vagrant.yml&amp;quot;
    end
  end

end
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible group variables&lt;/h3&gt;
&lt;p&gt;The variables for Ansible are defined in group_vars/vagrant, which pulls them in from the two environment variables set on my Mac.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;group_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;
&lt;span class="n"&gt;ansible_ssh_user&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;

&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;AWS&lt;/span&gt; &lt;span class="n"&gt;keys&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;are&lt;/span&gt; &lt;span class="n"&gt;read&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="n"&gt;and&lt;/span&gt; &lt;span class="n"&gt;passed&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;VM&lt;/span&gt;
&lt;span class="n"&gt;aws_access_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_ACCESS_KEY_ID&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;aws_secret_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_SECRET_ACCESS_KEY&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible playbook&lt;/h3&gt;
&lt;p&gt;The playbook at web-vagrant.yml that defines Anisble tasks has this section in it.  Note it doesn't have:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;- name: Copy AWS creds from Vagrant host to Vagrant VM&lt;/span&gt;
&lt;span class="x"&gt;  hosts: all&lt;/span&gt;
&lt;span class="x"&gt;  user: &amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;ansible_ssh_user&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="x"&gt;  sudo: yes&lt;/span&gt;
&lt;span class="x"&gt;  gather_facts: false&lt;/span&gt;

&lt;span class="x"&gt;  tasks:&lt;/span&gt;
&lt;span class="x"&gt;  - name: Create the boto config file&lt;/span&gt;
&lt;span class="x"&gt;    template: &amp;gt;&lt;/span&gt;
&lt;span class="x"&gt;      src=vagrant/templates/boto.cfg.j2&lt;/span&gt;
&lt;span class="x"&gt;      dest=/etc/boto.cfg&lt;/span&gt;
&lt;span class="x"&gt;    when: group_name == &amp;quot;vagrant&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The boto template&lt;/h3&gt;
&lt;p&gt;And that boto template is just this small file, placed in vagrant/templates/boto.cfg.j2&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;[Credentials]&lt;/span&gt;
&lt;span class="na"&gt;aws_access_key_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_access_key }}&lt;/span&gt;
&lt;span class="na"&gt;aws_secret_access_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_secret_key }}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Testing this out&lt;/h2&gt;
&lt;p&gt;With Ansible, Vagrant, and Virtualbox installled, create these four files and put them in their correct places.  The directory structure should look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;.
├── Vagrantfile
├── group_vars
│   └── vagrant
├── vagrant
│   └── templates
│       └── boto.cfg.j2
└── web-vagrant.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Open a command prompt, and type these commands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant up
vagrant ssh
cat /etc/boto.cfg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The AWS keys from your Mac should be now inserted into boto.cfg.&lt;/p&gt;
&lt;p&gt;To reprovision the Vagrant box, use "vagrant provision" to rerun the Ansible playbook.&lt;/p&gt;
&lt;p&gt;When you're done, dispose of the Vagrant VM with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant destroy
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Going further&lt;/h2&gt;
&lt;p&gt;You could also do the same to create a config file for the &lt;a href="http://aws.amazon.com/cli/"&gt;AWS CLI tool&lt;/a&gt; if you're looking for something at the command line&lt;/p&gt;
&lt;p&gt;I didn't need this--in production, Boto will use the credentials taken from the instance's IAM role that it was launched with.&lt;/p&gt;</summary><category term="ansible"></category><category term="aws"></category></entry><entry><title>Passing AWS Credentials to Vagrant in Ansible</title><link href="https://danlmarmot.github.io/blog/2014/10/15/aws-creds-to-vagrant-with-ansible/" rel="alternate"></link><updated>2014-10-15T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-10-15:blog/2014/10/15/aws-creds-to-vagrant-with-ansible/</id><summary type="html">&lt;p&gt;I needed my Vagrant instance to have AWS credentials to access an S3 bucket, but didn't want to hardcode them anywhere.  I simple wanted to pass the values of the environment variables to Vagrant, and have it use those.&lt;/p&gt;
&lt;p&gt;Since I was going to use Boto to get at that S3 bucket, I figured I just needed a way to set the variables in /etc/boto.conf on the Vagrant instance.&lt;/p&gt;
&lt;h3&gt;The Vagrantfile&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;VAGRANTFILE_API_VERSION = &amp;quot;2&amp;quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.define &amp;quot;web&amp;quot; do |web|
    web.vm.box = &amp;quot;ubuntu/trusty64&amp;quot;
    web.vm.provision &amp;quot;ansible&amp;quot; do |ansible|
      ansible.extra_vars = &amp;quot;@group_vars/vagrant&amp;quot;
      ansible.groups = {
        &amp;quot;vagrant&amp;quot; =&amp;gt; [&amp;quot;web&amp;quot;]
      }     
      ansible.playbook = &amp;quot;web-vagrant.yml&amp;quot;
    end
  end

end
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible group variables&lt;/h3&gt;
&lt;p&gt;The variables for Ansible are defined in group_vars/vagrant, which pulls them in from the two environment variables set on my Mac.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;group_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;
&lt;span class="n"&gt;ansible_ssh_user&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;

&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;AWS&lt;/span&gt; &lt;span class="n"&gt;keys&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;are&lt;/span&gt; &lt;span class="n"&gt;read&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="n"&gt;and&lt;/span&gt; &lt;span class="n"&gt;passed&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;VM&lt;/span&gt;
&lt;span class="n"&gt;aws_access_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_ACCESS_KEY_ID&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;aws_secret_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_SECRET_ACCESS_KEY&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible playbook&lt;/h3&gt;
&lt;p&gt;The playbook at web-vagrant.yml that defines Anisble tasks has this section in it.  Note it doesn't have:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;- name: Copy AWS creds from Vagrant host to Vagrant VM&lt;/span&gt;
&lt;span class="x"&gt;  hosts: all&lt;/span&gt;
&lt;span class="x"&gt;  user: &amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;ansible_ssh_user&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="x"&gt;  sudo: yes&lt;/span&gt;
&lt;span class="x"&gt;  gather_facts: false&lt;/span&gt;

&lt;span class="x"&gt;  tasks:&lt;/span&gt;
&lt;span class="x"&gt;  - name: Create the boto config file&lt;/span&gt;
&lt;span class="x"&gt;    template: &amp;gt;&lt;/span&gt;
&lt;span class="x"&gt;      src=vagrant/templates/boto.cfg.j2&lt;/span&gt;
&lt;span class="x"&gt;      dest=/etc/boto.cfg&lt;/span&gt;
&lt;span class="x"&gt;    when: group_name == &amp;quot;vagrant&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The boto template&lt;/h3&gt;
&lt;p&gt;And that boto template is just this small file, placed in vagrant/templates/boto.cfg.j2&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;[Credentials]&lt;/span&gt;
&lt;span class="na"&gt;aws_access_key_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_access_key }}&lt;/span&gt;
&lt;span class="na"&gt;aws_secret_access_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_secret_key }}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Testing this out&lt;/h2&gt;
&lt;p&gt;With Ansible, Vagrant, and Virtualbox installled, create these four files and put them in their correct places.  The directory structure should look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;.
├── Vagrantfile
├── group_vars
│   └── vagrant
├── vagrant
│   └── templates
│       └── boto.cfg.j2
└── web-vagrant.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Open a command prompt, and type these commands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant up
vagrant ssh
cat /etc/boto.cfg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The AWS keys from your Mac should be now inserted into boto.cfg.&lt;/p&gt;
&lt;p&gt;To reprovision the Vagrant box, use "vagrant provision" to rerun the Ansible playbook.&lt;/p&gt;
&lt;p&gt;When you're done, dispose of the Vagrant VM with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant destroy
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Going further&lt;/h2&gt;
&lt;p&gt;You could also do the same to create a config file for the &lt;a href="http://aws.amazon.com/cli/"&gt;AWS CLI tool&lt;/a&gt; if you're looking for something at the command line&lt;/p&gt;
&lt;p&gt;I didn't need this--in production, Boto will use the credentials taken from the instance's IAM role that it was launched with.&lt;/p&gt;</summary><category term="ansible"></category><category term="aws"></category></entry><entry><title>Passing AWS Credentials to Vagrant in Ansible</title><link href="https://danlmarmot.github.io/blog/2014/10/15/aws-creds-to-vagrant-with-ansible/" rel="alternate"></link><updated>2014-10-15T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-10-15:blog/2014/10/15/aws-creds-to-vagrant-with-ansible/</id><summary type="html">&lt;p&gt;I needed my Vagrant instance to have AWS credentials to access an S3 bucket, but didn't want to hardcode them anywhere.  I simple wanted to pass the values of the environment variables to Vagrant, and have it use those.&lt;/p&gt;
&lt;p&gt;Since I was going to use Boto to get at that S3 bucket, I figured I just needed a way to set the variables in /etc/boto.conf on the Vagrant instance.&lt;/p&gt;
&lt;h3&gt;The Vagrantfile&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;VAGRANTFILE_API_VERSION = &amp;quot;2&amp;quot;
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.define &amp;quot;web&amp;quot; do |web|
    web.vm.box = &amp;quot;ubuntu/trusty64&amp;quot;
    web.vm.provision &amp;quot;ansible&amp;quot; do |ansible|
      ansible.extra_vars = &amp;quot;@group_vars/vagrant&amp;quot;
      ansible.groups = {
        &amp;quot;vagrant&amp;quot; =&amp;gt; [&amp;quot;web&amp;quot;]
      }     
      ansible.playbook = &amp;quot;web-vagrant.yml&amp;quot;
    end
  end

end
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible group variables&lt;/h3&gt;
&lt;p&gt;The variables for Ansible are defined in group_vars/vagrant, which pulls them in from the two environment variables set on my Mac.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;group_name&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;
&lt;span class="n"&gt;ansible_ssh_user&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;vagrant&lt;/span&gt;

&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;AWS&lt;/span&gt; &lt;span class="n"&gt;keys&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;are&lt;/span&gt; &lt;span class="n"&gt;read&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;Vagrant&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="n"&gt;and&lt;/span&gt; &lt;span class="n"&gt;passed&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;VM&lt;/span&gt;
&lt;span class="n"&gt;aws_access_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_ACCESS_KEY_ID&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;aws_secret_key&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;{{ lookup(&amp;#39;env&amp;#39;,&amp;#39;AWS_SECRET_ACCESS_KEY&amp;#39;) }}&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The Ansible playbook&lt;/h3&gt;
&lt;p&gt;The playbook at web-vagrant.yml that defines Anisble tasks has this section in it.  Note it doesn't have:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;- name: Copy AWS creds from Vagrant host to Vagrant VM&lt;/span&gt;
&lt;span class="x"&gt;  hosts: all&lt;/span&gt;
&lt;span class="x"&gt;  user: &amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;ansible_ssh_user&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="x"&gt;  sudo: yes&lt;/span&gt;
&lt;span class="x"&gt;  gather_facts: false&lt;/span&gt;

&lt;span class="x"&gt;  tasks:&lt;/span&gt;
&lt;span class="x"&gt;  - name: Create the boto config file&lt;/span&gt;
&lt;span class="x"&gt;    template: &amp;gt;&lt;/span&gt;
&lt;span class="x"&gt;      src=vagrant/templates/boto.cfg.j2&lt;/span&gt;
&lt;span class="x"&gt;      dest=/etc/boto.cfg&lt;/span&gt;
&lt;span class="x"&gt;    when: group_name == &amp;quot;vagrant&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;The boto template&lt;/h3&gt;
&lt;p&gt;And that boto template is just this small file, placed in vagrant/templates/boto.cfg.j2&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;[Credentials]&lt;/span&gt;
&lt;span class="na"&gt;aws_access_key_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_access_key }}&lt;/span&gt;
&lt;span class="na"&gt;aws_secret_access_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;{{ aws_secret_key }}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Testing this out&lt;/h2&gt;
&lt;p&gt;With Ansible, Vagrant, and Virtualbox installled, create these four files and put them in their correct places.  The directory structure should look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;.
├── Vagrantfile
├── group_vars
│   └── vagrant
├── vagrant
│   └── templates
│       └── boto.cfg.j2
└── web-vagrant.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Open a command prompt, and type these commands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant up
vagrant ssh
cat /etc/boto.cfg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The AWS keys from your Mac should be now inserted into boto.cfg.&lt;/p&gt;
&lt;p&gt;To reprovision the Vagrant box, use "vagrant provision" to rerun the Ansible playbook.&lt;/p&gt;
&lt;p&gt;When you're done, dispose of the Vagrant VM with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant destroy
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Going further&lt;/h2&gt;
&lt;p&gt;You could also do the same to create a config file for the &lt;a href="http://aws.amazon.com/cli/"&gt;AWS CLI tool&lt;/a&gt; if you're looking for something at the command line&lt;/p&gt;
&lt;p&gt;I didn't need this--in production, Boto will use the credentials taken from the instance's IAM role that it was launched with.&lt;/p&gt;</summary><category term="ansible"></category><category term="aws"></category></entry><entry><title>Spark 1.1 and standalone Python scripts</title><link href="https://danlmarmot.github.io/blog/2014/10/13/spark1-1_python_standalone/" rel="alternate"></link><updated>2014-10-13T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-10-13:blog/2014/10/13/spark1-1_python_standalone/</id><summary type="html">&lt;p&gt;The Github repo for this is here: https://github.com/danlmarmot/demo-spark1.1-python&lt;/p&gt;
&lt;h2&gt;Install Spark&lt;/h2&gt;
&lt;p&gt;We're going to install Spark in ~/bin/spark from pre-built versions on Apache.  You already should've installed Java--this post assumes an Oracle version of Java.&lt;/p&gt;
&lt;p&gt;Open a Terminal window, then run these commands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;mkdir -p ~/bin/spark; cd &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;_&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;wget http://d3kbcqa49mib13.cloudfront.net/spark-1.1.0-bin-hadoop2.4.tgz&lt;/span&gt;
&lt;span class="x"&gt;tar -zxvf spark-1.1.0-bin-hadoop2.4.tgz; ln -s spark-1.1.0-bin-hadoop2.4 current; cd current&lt;/span&gt;
&lt;span class="x"&gt;bin/pyspark&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that I'm putting Spark as a symlink at ~/bin/spark/current, to allow for any scripts I create to reference a fixed location for Spark.&lt;/p&gt;
&lt;h3&gt;Turn down Spark's logging verbosity&lt;/h3&gt;
&lt;p&gt;Spark's logging spews out a lot.  Turn it down with these two commands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;cd ~/bin/spark/current
cp conf/log4j.properties.template conf/log4j.properties
sed -i&amp;#39;&amp;#39; -e &amp;#39;s/log4j.rootCategory=INFO/log4j.rootCategory=WARN/g&amp;#39; conf/log4j.properties
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Yes, that sed one-liner looks odd but this is a Mac with BSD sed, and not GNU sed.&lt;/p&gt;
&lt;h2&gt;Add your first Python script&lt;/h2&gt;
&lt;p&gt;This first script goes through and simply counts the number of lines with a's and b's in the Spark 1.1 Read Me.  It's not dependent on anything other than the Spark install location.&lt;/p&gt;
&lt;p&gt;Create a new file called readme_count_ab.py, and dump this text into it:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/env python&lt;/span&gt;

&lt;span class="c"&gt;# Run this with either python readme_count_ab.py, or ./readme_count_ab.py&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;

&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HOME&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;bin/spark/current/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;python&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;python/lib/py4j-0.8.2.1-src.zip&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyspark&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;SparkContext&lt;/span&gt;

&lt;span class="n"&gt;read_me&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;README.md&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;sc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SparkContext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;local&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Read Me&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;read_me_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;textFile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;read_me&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;numAs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;read_me_data&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;a&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;numBs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;read_me_data&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;b&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Lines with a: &lt;/span&gt;&lt;span class="si"&gt;%i&lt;/span&gt;&lt;span class="s"&gt;, lines with b: &lt;/span&gt;&lt;span class="si"&gt;%i&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;numAs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;numBs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c"&gt;# A couple of assertions to make sure things are correct&lt;/span&gt;
&lt;span class="k"&gt;assert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;numAs&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="mi"&gt;83&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;assert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;numBs&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="mi"&gt;38&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Run this with ./readme_count_ab.py&lt;/p&gt;
&lt;h2&gt;Add a second Python script - the word count&lt;/h2&gt;
&lt;p&gt;This next script also uses Spark to count words in the ReadMe.txt.  Go ahead and create a new file called readme_word_count.py, with this text inside:&lt;/p&gt;
&lt;table class="highlighttable"&gt;&lt;tr&gt;&lt;td class="linenos"&gt;&lt;div class="linenodiv"&gt;&lt;pre&gt; 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26&lt;/pre&gt;&lt;/div&gt;&lt;/td&gt;&lt;td class="code"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="n"&gt;__author__&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;dmckean&amp;#39;&lt;/span&gt;

&lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;span class="sd"&gt;    Run this with either python readme_word_count.py, or ./readme_word_count.py&lt;/span&gt;
&lt;span class="sd"&gt;&amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;

&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pprint&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;pprint&lt;/span&gt;


&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HOME&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;bin/spark/current/&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;python&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;python/lib/py4j-0.8.2.1-src.zip&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pyspark&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;SparkContext&lt;/span&gt;

&lt;span class="n"&gt;sc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;SparkContext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;local&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;Read Me&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;read_me_data&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;textFile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SPARK_HOME&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;README.md&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;counts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;read_me_data&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;flatMap&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;\
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;map&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;word&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;word&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;\
    &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reduceByKey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;word_counts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;counts&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;collect&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;pprint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;word_counts&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;Run this with ./readme_count_words.py or python readme_count_words.py&lt;/p&gt;
&lt;p&gt;This second script will print out a list of all 166 words in the Read Me.
Note that the data isn't really cleaned up--there are punctuation and other things included as part of each word.  That 
cleanup is best left for another exercise; after all, so much of big data stuff is just cleaning up the input data!&lt;/p&gt;</summary><category term="spark"></category><category term="python"></category></entry><entry><title>A blog makeover</title><link href="https://danlmarmot.github.io/blog/2014/10/10/blog-makeover/" rel="alternate"></link><updated>2014-10-10T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-10-10:blog/2014/10/10/blog-makeover/</id><summary type="html">&lt;p&gt;Pelican was fun to learn, with fairly decent documentation... but some of the "how do I do this" articles were really lacking in details, or just out-of-date.&lt;/p&gt;
&lt;p&gt;I really wanted to get the blog restyled, and Disqus comments enabled, and some date-based organization for posts... so I spent this Friday evening doing just
that and wandering not-too-far down some rabbit holes before coming up with this passable blog.&lt;/p&gt;
&lt;p&gt;And since this is a blog, I should really write about how I did that.  I'll save that for future blog posts.&lt;/p&gt;</summary><category term="blogging"></category></entry><entry><title>Provisioning with Vagrant, Ansible, and Packer</title><link href="https://danlmarmot.github.io/blog/2014/08/11/provisioning-with-vagrant-ansible-packer/" rel="alternate"></link><updated>2014-08-11T18:55:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-08-11:blog/2014/08/11/provisioning-with-vagrant-ansible-packer/</id><summary type="html">&lt;p&gt;One big issue in using servers on cloud providers suck as Amazon Web Services, Rackspace, and Google Compute Engine is dealing with their provisioning and deployment--in other words, how to build them out to begin with.
Sure, you can write lots of Bash scripts, invest in Puppet and Chef training and infrastructure, and script the whole thing out.  I've tried some of those, but generally found them real burdensome and in general they hinder productivity, not improve it.&lt;/p&gt;
&lt;p&gt;Ansible is a more recent utility that aims to be simpler to use by developers, and I've found it better integrates with my workflows, and is much less difficult to maintain. Ansible works strictly over SSH and doesn't require you to manage any additional infrastructure such as a server--and I like the fact that you don't have to install agents on the machines you manage, so you don't have the tricky problem of bootstrapping with cloud-init.&lt;/p&gt;
&lt;p&gt;This lengthy blog post focuses on using Ansible with Vagrant and Packer, so that we can automate the provisioning of virtual machines for development, QA, CI, and production.  For development, we'll be using Vagrant, and for cloud deployments we'll be using Packer to create machine images for Amazon.&lt;/p&gt;
&lt;h2&gt;A few terms first&lt;/h2&gt;
&lt;p&gt;To get on the same page, here's some terms and conventions I'm using in this article.&lt;/p&gt;
&lt;h3&gt;Provisioning&lt;/h3&gt;
&lt;p&gt;Provisioning is the initial configuration and setup of a machine instance, including installation of all pre-requisite packages and software, creation of user and service accounts, and configuration. It's what you have to do before you install any of your applications. Provisioning also generally includes common monitoring tools and utilities to make sure the machine can update its health status or emit metrics to the operations infrastructure.&lt;/p&gt;
&lt;h3&gt;Deployment&lt;/h3&gt;
&lt;p&gt;Deployment is simply putting one or more applications on the machine. After provisioning, an initial deployment is typically done.  An image is often created as well, before or after the deployment.&lt;/p&gt;
&lt;h3&gt;Environment&lt;/h3&gt;
&lt;p&gt;An environment is a collection of services and machines that depend on each other. Think of the term "environment" as meaning "production environment" or "staging environment" or "local environment". Different development teams use different terms.&lt;/p&gt;
&lt;h3&gt;Machine Image&lt;/h3&gt;
&lt;p&gt;Machine images are snapshots of machine, usually with all software and dependencies installed, and perhaps an initial deployment of up-to-date code. They are provider-specific: Amazon machine images aren't the same as VMware machine images or Digital Ocean machine images, and often have to be created with provider-specific tools.&lt;/p&gt;
&lt;h2&gt;Prep Work&lt;/h2&gt;
&lt;p&gt;This document is really meant to be used by Mac users, and in particular folks running MacOS 10.9. Vagrant/Packer/Ansible are all oriented towards various Unix flavors, and don't fully support Windows. Other operating systems related to Linux are supported, such as Mac OS X, Ubuntu, Centos, Fedora, AmazonLinux, and versions of FreeBSD.  But I'm just using my Mac.&lt;/p&gt;
&lt;h2&gt;Step 0 - Clone the Github repository&lt;/h2&gt;
&lt;p&gt;For this demo, the code's on Github.  You can get it with this command&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git clone https://github.com/danlmarmot/demo-ansible-vagrant-packer&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Clone it onto your local Mac--if you need help at this point, see the Github help pages.&lt;/p&gt;
&lt;h2&gt;Step 1 - Install Vagrant and VirtualBox&lt;/h2&gt;
&lt;p&gt;With the source code checked out, change into the checked out git repo with&lt;/p&gt;
&lt;p&gt;&lt;code&gt;cd demo-ansible-vagrant-packer/&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;We will not be changing out of this directory, so you're good at this point.&lt;/p&gt;
&lt;h3&gt;Install VirtualBox and Vagrant&lt;/h3&gt;
&lt;p&gt;VirtualBox is available at https://www.virtualbox.org/wiki/Downloads.&lt;/p&gt;
&lt;p&gt;Vagrant is at https://www.vagrantup.com/downloads.html&lt;/p&gt;
&lt;p&gt;Once you've installed, enter these commands to verify your installation
At a command prompt type the following and ensure there aren't any errors.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;vagrant -v&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;Initialize Vagrant&lt;/h3&gt;
&lt;p&gt;Look at the Vagrantfile at the root of your checkout. It should look like this if you've checked it out from Git -- if you haven't, make it look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="no"&gt;Vagrant&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;configure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;VAGRANTFILE_API_VERSION&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;box&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ubuntu/trusty64&amp;quot;&lt;/span&gt;
  &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;network&lt;/span&gt; &lt;span class="ss"&gt;:private_network&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;192.168.111.222&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This just says launch an Ubuntu Trusty 64-bit image (which is Ubuntu 14.04 LTS, released in April 2014).&lt;/p&gt;
&lt;p&gt;&lt;em&gt;A side note: Vagrantfiles are written in Ruby syntax--if you know Ruby, you can add additional logic to them.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Launch the VM with 'vagrant up':&lt;/p&gt;
&lt;p&gt;&lt;code&gt;vagrant up&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;You should see:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;Bringing machine &amp;#39;default&amp;#39; up with &amp;#39;virtualbox&amp;#39; provider...
==&amp;gt; default: Box &amp;#39;ubuntu/trusty64&amp;#39; could not be found. Attempting to find and
install...
    default: Box Provider: virtualbox
    default: Box Version: &amp;gt;= 0
==&amp;gt; default: Loading metadata for box &amp;#39;ubuntu/trusty64&amp;#39;
    default: URL: https://vagrantcloud.com/ubuntu/trusty64
==&amp;gt; default: Adding box &amp;#39;ubuntu/trusty64&amp;#39; (v14.04) for provider: virtualbox
    default: Downloading:
https://vagrantcloud.com/ubuntu/trusty64/version/1/provider/virtualbox.box
    default: Progress: 33% (Rate: 1274k/s, Estimated time remaining: 0:01:03)
Connect with SSH to the Vagrant VM:
vagrant ssh
Welcome to Ubuntu 14.04 LTS (GNU/Linux 3.13.0-24-generic x86_64)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now you've got a Vagrant-managed VM to work with! Exit the SSH prompt with:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;exit&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;Step 2 - Add Ansible to manage the Vagrant VM&lt;/h3&gt;
&lt;p&gt;We'll be using Ansible, which works over SSH to configure the VM, reading from YAML files to drive the configuration. Ansible doesn't require any software to be installed on the VM (it's agentless).  I put my Ansible YAML files are checked into source control alongside the Vagrantfile into a directory called provision.&lt;/p&gt;
&lt;p&gt;This Ansible YAML document describing the steps to perform is called a playbook. Vagrant knows how to use Ansible to provision the instance, with a reference to that YAML file in the the Vagrantfile.&lt;/p&gt;
&lt;p&gt;To make sure things all work, we're going to do a really simple task: create the directory /tmp/foo on the Vagrant VMVM.&lt;/p&gt;
&lt;h4&gt;Resources&lt;/h4&gt;
&lt;p&gt;There are a lot of resources on the web that describe these steps.  These are the ones I found handy are handy when you get done with walking through this guide:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://docs.ansible.com/guide_vagrant.html"&gt;http://docs.ansible.com/guide_vagrant.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://docs.vagrantup.com/v2/provisioning/ansible.html"&gt;http://docs.vagrantup.com/v2/provisioning/ansible.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://www.digitalocean.com/community/articles/how-to-create-ansible-playbooks-to-automate-system-configuration-on-ubuntu"&gt;https://www.digitalocean.com/community/articles/how-to-create-ansible-playbooks-to-automate-system-configuration-on-ubuntu&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Install Ansible&lt;/h3&gt;
&lt;p&gt;First, we need to install Ansible, which is a Python package.  Mac OS X 10.9 has Python 2.7 pre-installed.&lt;/p&gt;
&lt;p&gt;We will install Ansible globally, and not in a virtual environment–it's not a heavy installation, and doesn't require any other software dependencies apart from a few other Python packages. One of these Python packages for SSH will need to be compiled with XCode, so you'll need the XCode (available from the App Store) and the XCode command line tools installed.&lt;/p&gt;
&lt;p&gt;Run these two commands to install Ansible. The first ensures pip is installed (the standard Python package manager), then the next installs or upgrades Ansible if you've previously installed it.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo easy_install pip; sudo pip install ansible --upgrade&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;An Important XCode Gotcha&lt;/h3&gt;
&lt;p&gt;On MacOS X with some versions of XCode, if you get an error about "-Wno-error=unused-command-line-argument-hard-error-in-future" you can supress the warning by installing Ansible with this ugly command.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sudo ARCHFLAGS=-Wno-error=unused-command-line-argument-hard-error-in-future pip install ansible --upgrade&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Side note: This is a tedious warning, and if you install other Python packages or Ruby gems that require compiling you'll hit this over and over. You can add this your your ~/.bash_profile on your Mac to get around this.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;echo export ARCHFLAGS=-Wno-error=unused-command-line-argument-hard-error-in-future &amp;gt;&amp;gt;
~/.bash_profile; source ~/.bash_profile&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;Update the source code to step 2&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;git checkout -f tags/step2&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;Add an Ansible playbook&lt;/h3&gt;
&lt;p&gt;This playbook will be at the top of our directory, and we'll name it "playbook.yml".&lt;/p&gt;
&lt;p&gt;You can write this out yourself, or just look at what Git checked out.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;---
- name: Verify ansible works
  hosts: all
  user: vagrant
  sudo: yes
  gather_facts: false
  tasks:
    - name: Create /tmp/foo
      file: path=/tmp/foo state=directory
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Update the Vagrantfile with Ansible provisioning&lt;/h3&gt;
&lt;p&gt;Now let's add the Ansible provisioner to the Vagrantfile--that's the file that tells Vagrant to use Ansible to build out the VM. That entire file should look like this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="no"&gt;VAGRANTFILE_API_VERSION&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;
&lt;span class="no"&gt;Vagrant&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;configure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;VAGRANTFILE_API_VERSION&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;box&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ubuntu/trusty64&amp;quot;&lt;/span&gt;
  &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;network&lt;/span&gt; &lt;span class="ss"&gt;:private_network&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;192.168.111.222&amp;quot;&lt;/span&gt;
  &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;provision&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ansible&amp;quot;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;playbook&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;playbook.yml&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;extra_vars&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="ss"&gt;ansible_ssh_user&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;vagrant&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;verbose&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;vv&amp;quot;&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Provision the VM&lt;/h3&gt;
&lt;p&gt;This is where the magic happens. Run it from a command prompt with&lt;/p&gt;
&lt;p&gt;&lt;code&gt;vagrant provision&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;If everything's setup correctly, you'll see output similar to this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;==&amp;gt; default: Running provisioner: ansible...
ANSIBLE_FORCE_COLOR=true ANSIBLE_HOST_KEY_CHECKING=false PYTHONUNBUFFERED=1 ansible-playbook --private-key=/Users/Marmot/.vagrant.d/insecure_private_key --user=vagrant --limit=&amp;#39;default&amp;#39; --inventory-file=/Users/Marmot/dev/bb-danlmarmot/demo-ansible-vagrant-packer/.vagrant/provisioners/ansible/inventory --extra-vars={&amp;quot;ansible_ssh_user&amp;quot;:&amp;quot;vagrant&amp;quot;} -vv playbook.yml

PLAY [Verify ansible works] ***************************************************

TASK: [Create /tmp/foo] *******************************************************
&amp;lt;127.0.0.1&amp;gt; REMOTE_MODULE file path=/tmp/foo state=directory
changed: [default] =&amp;gt; {&amp;quot;changed&amp;quot;: true, &amp;quot;gid&amp;quot;: 0, &amp;quot;group&amp;quot;: &amp;quot;root&amp;quot;, &amp;quot;mode&amp;quot;: &amp;quot;0755&amp;quot;, &amp;quot;owner&amp;quot;: &amp;quot;root&amp;quot;, &amp;quot;path&amp;quot;: &amp;quot;/tmp/foo&amp;quot;, &amp;quot;size&amp;quot;: 4096, &amp;quot;state&amp;quot;: &amp;quot;directory&amp;quot;, &amp;quot;uid&amp;quot;: 0}

PLAY RECAP ********************************************************************
default                    : ok=1    changed=1    unreachable=0    failed=0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;At this point Ansible and Vagrant are working with each other. That's a big win, and now we can start doing more complicated things.&lt;/p&gt;
&lt;h4&gt;Troubleshooting "vagrant provision"&lt;/h4&gt;
&lt;h5&gt;Error: "VM not created"&lt;/h5&gt;
&lt;p&gt;If you get a message similar to this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant provision
==&amp;gt; default: VM not created. Moving on...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Fix it by:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;vagrant up&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;This is just simply because the Vagrant VM isn't running, so it can't receive the &lt;code&gt;vagrant provision&lt;/code&gt; command&lt;/p&gt;
&lt;h3&gt;Verify that the provisioning worked&lt;/h3&gt;
&lt;p&gt;Now let's verify this worked by SSH-ing into the Vagrant VM.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant ssh
vagrant@vagrant-ubuntu-trusty-64:~$ ls /tmp
foo
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Exit out of the SSH session&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant@vagrant-ubuntu-trusty-64:~$ exit
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Destroy the Vagrant VM&lt;/h3&gt;
&lt;p&gt;We won't be using this simple VM in the following steps--it was good to verify that Ansible is setup correctly--so we'll destroy it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;vagrant destroy
    default: Are you sure you want to destroy the &amp;#39;default&amp;#39; VM? [y/N] y
==&amp;gt; default: Forcing shutdown of VM...
==&amp;gt; default: Destroying VM and associated drives...
==&amp;gt; default: Running cleanup tasks for &amp;#39;ansible&amp;#39; provisioner...
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Step 3 - Using Ansible to provision nginx&lt;/h2&gt;
&lt;p&gt;Ansible can be used for quite a bit more than create directories from a single playbook file, and can manipulate a fair number of resources from system settings (users, groups, cronjobs, package repositories) to applications (Apache httpd, ntpd) to cloud assets (AWS EC2 instances, OpenStack storage).  For a full list visit http://docs.ansible.com/modules_by_category.html&lt;/p&gt;
&lt;p&gt;This is also when we'll start using more typical Ansible conventions.&lt;/p&gt;
&lt;h3&gt;Resources&lt;/h3&gt;
&lt;p&gt;&lt;a href="http://docs.ansible.com/playbooks_best_practices.html"&gt;http://docs.ansible.com/playbooks_best_practices.html&lt;/a&gt; has a good walk-through of a non-trivial site layout involving a few different types of servers in a few different server locations.&lt;/p&gt;
&lt;h3&gt;Update source&lt;/h3&gt;
&lt;p&gt;In that same directory, update the source code to step 3&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git checkout -f tags/step3&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;Create the provisioning directory for nginx&lt;/h3&gt;
&lt;p&gt;Ansible has a recommended convention for laying out a directory. The docs are here, &lt;a href="http://docs.ansible.com/playbooks_best_practices.html"&gt;http://docs.ansible.com/playbooks_best_practices.html&lt;/a&gt;, and they're a good walk-through of a non-trivial layout.&lt;/p&gt;
&lt;p&gt;The following steps show what you'll have to do manually--if you haven't checked out step3 from git, do these manually. First, create a directory to hold our Ansible provisioning files.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;mkdir provision&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Create the nginx role in Ansible&lt;/p&gt;
&lt;p&gt;Now, add an Ansible role to install nginx:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ansible-galaxy init roles/nginx&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;And let's edit some files. Note that each file should start with the three dashes, which indicates it's a YAML file.  (Ansible isn't all that picky on those three dashes, though) The entire contents of all the file are listed below:&lt;/p&gt;
&lt;h4&gt;roles/nginx/tasks/main.yml&lt;/h4&gt;
&lt;p&gt;This is the main list of tasks that Ansible performs when it's provisioning the nginx role. These tasks are performed sequentially, there's no "convergence" phase at runtime as there are in other tools.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;---
 - name: add nginx ppa repository
   apt_repository: repo=&amp;#39;ppa:nginx/stable&amp;#39;

 - name: install nginx
   apt: pkg=nginx state=installed

 - name: remove default site
   file: path=/etc/nginx/sites-enabled/default state=absent
   notify: restart nginx  

 - name: add our nginx.conf
   copy: src=nginx.conf dest=/etc/nginx/nginx.conf owner=root group=root mode=644
   notify: restart nginx  

 - name: add static directory
   file: path=/opt/static state=directory

 - name: add static site index.htm file
   copy: src=index.html dest=/opt/static/index.html owner=root group=root mode=644
   notify: restart nginx  

 - name: add nginx config file for static site
   copy: src=static.conf dest=/etc/nginx/conf.d/static.conf owner=root group=root mode=644
   notify: restart nginx  

 - name: start nginx
   service: name=nginx state=started
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;nginx/tasks/handlers.yml&lt;/h4&gt;
&lt;p&gt;Handlers are actions that are triggered when task does something.  With this nginx example, we'll want to restart nginx if we change the config files for nginx or the static site we're serving.&lt;/p&gt;
&lt;p&gt;We have two handlers to do this.  The 'restart nginx' handler (which is called whenever a file changes through the task list above), and the 'verify nginx' handler to make sure nginx still works. The first 'restart nginx' handler calls the second handler with the notify statement.&lt;/p&gt;
&lt;p&gt;That second handler just performs a "curl" command to make sure nginx is working.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;---
 - name: restart nginx
   service: name=nginx state=restarted
   notify: verify nginx

 - name: verify nginx
   shell: curl 127.0.0.1:8080
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;roles/nginx/files/nginx.conf&lt;/h4&gt;
&lt;p&gt;The nginx.conf file.  This is just a plain text file.  Ansible supports templates, but we're not using them in this walk-through.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;user www-data;
worker_processes 4;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    include /etc/nginx/conf.d/*.conf;
}
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;roles/nginx/files/static.conf&lt;/h4&gt;
&lt;p&gt;This text file just says where the static files live. We're putting them in /opt/static (many people put them in somewhere in /var, but I prefer to serve sites and web applications out of /opt/*)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;server {
    listen 8080;
    location / {
        root /opt/static;
        index index.html index.htm;
    }
}
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;roles/nginx/files/index.html&lt;/h4&gt;
&lt;p&gt;A static webpage that's served by nginx.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt; &amp;lt;html&amp;gt;
 &amp;lt;h2&amp;gt;Hey nginx works!&amp;lt;/h2&amp;gt;
 &amp;lt;/html&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;webserver.yml&lt;/h4&gt;
&lt;p&gt;This is an Ansible playbook to build out a webserver in our Vagrant environment.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;---
# file: webserver.yml
- hosts: all
  user: vagrant
  sudo: yes
  gather_facts: false
  roles:
    - nginx
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;site.yml&lt;/h4&gt;
&lt;p&gt;This describes the site.  There's just the one server type in there now.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;---
# file: site.yml
- include: webserver.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;A bit of explanation--how Ansible describes the site&lt;/h3&gt;
&lt;p&gt;Now that you've done all that... what's all that mean?&lt;/p&gt;
&lt;p&gt;With Ansible, the overall site is typically described by site.yml. It's a file that describes the entire site, and often it's pretty short and just includes other files, usually instances/servers/boxes by what they do, such as "web server" or "database server".&lt;/p&gt;
&lt;p&gt;With Ansible terminology the term "role" refers to a fairly specific package or software component, like nginx or MySQL.&lt;/p&gt;
&lt;p&gt;Ansible ends up having a tree of site components:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The overall site in site.yml. This lists all the server types like "web_server" or "database_server". Sites can also be described by location, such as "oregon_servers" or "dublin_servers"&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Server classes defined in &lt;server&gt;.yml file. This defines what roles are applied to each server type. Web servers might get nginx; database servers might get Postgres.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Roles in a &lt;rolename&gt; directory. Roles are encapuslated components, like redis or Apache web server, or a custom Java app in a Tomcat container.  The role directory has subdirectories inside where Ansible knows where to look, and the ones we use here are "files", "handlers", and "tasks".&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Update the Vagrantfile&lt;/h3&gt;
&lt;p&gt;We'll update the Vagrantfile to point to the new playbook, and refactor it a bit so it's easier to add new server types.&lt;/p&gt;
&lt;p&gt;We'll also expose port 8080, so we can open up a web browser on our Mac to see nginx serving pages.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="no"&gt;VAGRANTFILE_API_VERSION&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;

&lt;span class="no"&gt;Vagrant&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;configure&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;VAGRANTFILE_API_VERSION&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;define&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;webserver&amp;quot;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;webserver&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="n"&gt;webserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;box&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ubuntu/trusty64&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;webserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;network&lt;/span&gt; &lt;span class="ss"&gt;:private_network&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;192.168.111.222&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;webserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;network&lt;/span&gt; &lt;span class="ss"&gt;:forwarded_port&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;guest&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;8080&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;host&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;8080&lt;/span&gt;
    &lt;span class="n"&gt;webserver&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;vm&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;provision&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;ansible&amp;quot;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
      &lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;extra_vars&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="ss"&gt;ansible_ssh_user&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;vagrant&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
      &lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;verbose&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;vv&amp;quot;&lt;/span&gt;
      &lt;span class="n"&gt;ansible&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;playbook&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;webserver.yml&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Launch this new Vagrant instance with&lt;/p&gt;
&lt;p&gt;&lt;code&gt;vagrant up webserver&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Ansible will startup the new instance, install nginx and our single-page static site, and verify it's working with the curl command--look in the console output for the HTML.&lt;/p&gt;
&lt;h3&gt;Verify&lt;/h3&gt;
&lt;p&gt;You should also verify this works from your Mac--just visit &lt;a href="http://localhost:8080"&gt;http://localhost:8080&lt;/a&gt;, and you should see the "Hey nginx works!"&lt;/p&gt;
&lt;h3&gt;Reprovisioning&lt;/h3&gt;
&lt;p&gt;When you're developing with Ansible and Vagrant, you'll be tweaking your playbooks and task lists and files over and over, and you'll need a way to quickly rerun your work.  It takes a fairly long time to reimport a virtual machine from scratch, but Vagrant can reprovision your box with a simple command.&lt;/p&gt;
&lt;p&gt;Let's try that now: edit the index.html file inside roles/nginx/files/index.html to say "Heyyyyy nginx works", and save the file away.&lt;/p&gt;
&lt;p&gt;Now, rerun the provisioning on your Vagrant VM with&lt;/p&gt;
&lt;p&gt;&lt;code&gt;vagrant provision&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;You'll see that the index.htm file is changed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;TASK: [nginx | add static site index.htm file] ********************************
changed: [webserver] =&amp;gt; {&amp;quot;changed&amp;quot;: true, &amp;quot;dest&amp;quot;: &amp;quot;/opt/static/index.html&amp;quot;, &amp;quot;gid&amp;quot;: 0, &amp;quot;group&amp;quot;: &amp;quot;root&amp;quot;, &amp;quot;md5sum&amp;quot;: &amp;quot;02f40bd936f4d308a679c0fa636e317d&amp;quot;, &amp;quot;mode&amp;quot;: &amp;quot;0644&amp;quot;, &amp;quot;owner&amp;quot;: &amp;quot;root&amp;quot;, &amp;quot;size&amp;quot;: 46, &amp;quot;src&amp;quot;: &amp;quot;/home/vagrant/.ansible/tmp/ansible-tmp-1407855909.5-223798276574238/source&amp;quot;, &amp;quot;state&amp;quot;: &amp;quot;file&amp;quot;, &amp;quot;uid&amp;quot;: 0}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Because there is a notification handler on that file, nginx will be restarted and verified with curl:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;NOTIFIED: [nginx | restart nginx] *********************************************
&amp;lt;127.0.0.1&amp;gt; REMOTE_MODULE service name=nginx state=restarted
changed: [webserver] =&amp;gt; {&amp;quot;changed&amp;quot;: true, &amp;quot;name&amp;quot;: &amp;quot;nginx&amp;quot;, &amp;quot;state&amp;quot;: &amp;quot;started&amp;quot;}

NOTIFIED: [nginx | verify nginx] **********************************************
&amp;lt;127.0.0.1&amp;gt; REMOTE_MODULE command curl 127.0.0.1:8080 #USE_SHELL
changed: [webserver] =&amp;gt; {&amp;quot;changed&amp;quot;: true, &amp;quot;cmd&amp;quot;: &amp;quot;curl 127.0.0.1:8080 &amp;quot;, &amp;quot;delta&amp;quot;: &amp;quot;0:00:00.009759&amp;quot;, &amp;quot;end&amp;quot;: &amp;quot;2014-08-12 15:07:03.461307&amp;quot;, &amp;quot;rc&amp;quot;: 0, &amp;quot;start&amp;quot;: &amp;quot;2014-08-12 15:07:03.451548&amp;quot;, &amp;quot;stderr&amp;quot;: &amp;quot;  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\r  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r100    44  100    44    0     0  17908      0 --:--:-- --:--:-- --:--:-- 22000&amp;quot;, &amp;quot;stdout&amp;quot;: &amp;quot;&amp;lt;html&amp;gt;\n&amp;lt;h2&amp;gt;Heyyyyy nginx works!!&amp;lt;/h2&amp;gt;\n&amp;lt;/html&amp;gt;&amp;quot;}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You can (and should!) verify from your Mac's web browser by visiting &lt;a href="http://localhost:8080"&gt;http://localhost:8080&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;d&lt;/p&gt;</summary><category term="ansible"></category><category term="vagrant"></category><category term="packer"></category></entry><entry><title>How I setup blogging with Pelican</title><link href="https://danlmarmot.github.io/blog/2014/08/04/blog-setup-with-pelican/" rel="alternate"></link><updated>2014-08-04T00:00:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-08-04:blog/2014/08/04/blog-setup-with-pelican/</id><summary type="html">&lt;p&gt;For a long while, I've wanted to move to a decent blogging system.  I tried WordPress, but keeping it up-to-date with patches and running MySQL for content just seemed kind of wrong--I wanted something simpler and version controlled and not tied to particular server setup, so eventually I found my way to Pelican.&lt;/p&gt;
&lt;p&gt;And, following the unwritten mandatory rule that the first blog post should be about how a blog is setup, I present you with the magic "How I setup blogging with Pelican" post :-).&lt;/p&gt;
&lt;p&gt;I still have theming to do, but that's a different post than this one.&lt;/p&gt;
&lt;h3&gt;Getting going&lt;/h3&gt;
&lt;p&gt;For this blog, I'm using Pelican 3.4.0, and Github pages.&lt;/p&gt;
&lt;p&gt;I spent probably far too much time looking around at other tutorials and resources out there.--these two pages gave me enough insight on how to do this:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://guizishanren.com/guide-to-set-up-github-page-and-pelican"&gt;http://guizishanren.com/guide-to-set-up-github-page-and-pelican&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.circuidipity.com/pelican.html"&gt;http://www.circuidipity.com/pelican.html&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A small aside&lt;/strong&gt;: many tutorials are aimed more at writers than developers, and they struggle a bit with the concept of git branching and pushing.  Some suggest two different repositories are needed, but that's not necessary--just use a single Github repo with your editable content in the branch "master" and your static, hosted blog content in "gh-pages".  Github pages knows to serve static content out of any branch named "gh-pages".&lt;/p&gt;
&lt;p&gt;There's a plugin that helps you generate that static content, so you never have to switch branches either--you always work in master.&lt;/p&gt;
&lt;h2&gt;Setting up Pelican&lt;/h2&gt;
&lt;p&gt;Resources for working with Pelican and Github: http://docs.getpelican.com/en/3.4.0/tips.html are pretty good.  &lt;/p&gt;
&lt;p&gt;I'm using a Mac running MacOS 10.9, and my setup looks like this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The blog's content and scripts and everything will live in my home directory at ~/dev/blog&lt;/li&gt;
&lt;li&gt;All the Python stuff will be in a virtual environment, also kept in that same directory and .gitignore'd.&lt;/li&gt;
&lt;li&gt;I'll be writing posts in Markdown with Mou.&lt;/li&gt;
&lt;li&gt;The blog will be hosted on Github as a project page (not a personal or user page--this is an important distinction)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Install Pelican&lt;/h3&gt;
&lt;p&gt;Open a terminal window and enter these commands to install Pelican, Markdown, and ghp-import&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="x"&gt;sudo easy_install pip; sudo pip install virtualenv&lt;/span&gt;
&lt;span class="x"&gt;mkdir ~/dev/blog; cd &lt;/span&gt;&lt;span class="p"&gt;$&lt;/span&gt;&lt;span class="nv"&gt;_&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;virtualenv venv; . venv/bin/activate&lt;/span&gt;
&lt;span class="x"&gt;pip install pelican Markdown ghp-import&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Run the Pelican Quickstart&lt;/h3&gt;
&lt;p&gt;Most questions I accepted the default, except the pagination and Github one.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;pelican-quickstart

&amp;gt; Where do you want to create your new web site? [.]
&amp;gt; What will be the title of this web site? Dan&amp;#39;s Random Bits
&amp;gt; Who will be the author of this web site? Dan McKean
&amp;gt; What will be the default language of this web site? [en]
&amp;gt; Do you want to specify a URL prefix? e.g., http://example.com   (Y/n) Y
&amp;gt; What is your URL prefix? (see above example; no trailing slash) https://danlmarmot.github.io/blog

-- Note this change from default for pagination
&amp;gt; Do you want to enable article pagination? (Y/n) n
&amp;gt; How many articles per page do you want? [10]
&amp;gt; Do you want to generate a Fabfile/Makefile to automate generation and publishing? (Y/n)
&amp;gt; Do you want an auto-reload &amp;amp; simpleHTTP script to assist with theme and site development? (Y/n)
&amp;gt; Do you want to upload your website using FTP? (y/N)
&amp;gt; Do you want to upload your website using SSH? (y/N)
&amp;gt; Do you want to upload your website using Dropbox? (y/N)
&amp;gt; Do you want to upload your website using S3? (y/N)
&amp;gt; Do you want to upload your website using Rackspace Cloud Files? (y/N)

-- Note this is yes for Github pages.
&amp;gt; Do you want to upload your website using GitHub Pages? (y/N) y
&amp;gt; Is this your personal page (username.github.io)? (y/N) N
Done. Your new project is available at ~/dev/blog
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Initial Pelican Run&lt;/h3&gt;
&lt;p&gt;This will generate your blog and run a webserver to view your content.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;make devserver&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Open &lt;a href="http://localhost:8000"&gt;http://localhost:8000&lt;/a&gt; when it's finished to see what your blog looks like.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;:
On a second runthrough of these steps, I had an old instance of the devserver running.  Stop it and/or clean up its stale old pidfile with this command:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;./develop_server.sh stop&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;Write a blog post!&lt;/h3&gt;
&lt;p&gt;Now let's create that first post.  Make sure that terminal window's still open to that directory.  You can have the command prompt, that's fine.&lt;/p&gt;
&lt;p&gt;Open Mou. If you don't have Mou, install it from http://mouapp.com/ &lt;/p&gt;
&lt;p&gt;Create a file named "2014-0803.md" in the content directory, and add this text:  &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="n"&gt;Title&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;First&lt;/span&gt; &lt;span class="n"&gt;Post&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;
&lt;span class="n"&gt;Date&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;2014&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;08&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;03&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;50&lt;/span&gt;
&lt;span class="n"&gt;Tags&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;fun&lt;/span&gt;
&lt;span class="n"&gt;Category&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Tech&lt;/span&gt;
&lt;span class="n"&gt;Slug&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;my&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;first&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;post&lt;/span&gt;
&lt;span class="n"&gt;Summary&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;First&lt;/span&gt; &lt;span class="n"&gt;Post&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;blog&lt;/span&gt;

&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;Hey&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="n"&gt;an&lt;/span&gt; &lt;span class="n"&gt;initial&lt;/span&gt; &lt;span class="n"&gt;blog&lt;/span&gt; &lt;span class="n"&gt;post&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;

&lt;span class="n"&gt;Just&lt;/span&gt; &lt;span class="n"&gt;getting&lt;/span&gt; &lt;span class="n"&gt;started&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;  &lt;span class="n"&gt;More&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;come&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Save it away as "2014-0803.md" inside of your  /content … and your site will magically (and weirdly!) regenerate.&lt;/p&gt;
&lt;p&gt;View it at &lt;a href="http://localhost:8000"&gt;http://localhost:8000&lt;/a&gt; again--or just refresh the page if you left your browser window open.   You may need to refresh.&lt;/p&gt;
&lt;h2&gt;Add Git&lt;/h2&gt;
&lt;p&gt;Now let's put this blog under git on your local machine... and then we'll push your local git repository to Github.&lt;/p&gt;
&lt;h3&gt;Create a local git repo&lt;/h3&gt;
&lt;p&gt;In that same directory at ~/dev/blog, create a local Git repo, and a .gitignore file, and then add content and associated files:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;git init
echo -e &amp;quot;venv\n*.pyc\n*.pid\noutput/\ncache\n&amp;quot; &amp;gt; .gitignore
git add .
git status
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Make sure additional files aren't being checked in.  Mine looks like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;Changes to be committed:
  (use &amp;quot;git rm --cached &amp;lt;file&amp;gt;...&amp;quot; to unstage)

    new file:   .gitignore
    new file:   Makefile
    new file:   content/2014-0803.md
    new file:   develop_server.sh
    new file:   fabfile.py
    new file:   pelicanconf.py
    new file:   publishconf.py
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Commit to your local Git repo&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;git commit -m &amp;quot;Initial checkin&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Create a Github repo to hold your blog.&lt;/h3&gt;
&lt;p&gt;Visit &lt;a href="https://github.com/new"&gt;https://github.com/new&lt;/a&gt;, and call it just "blog".  Make it public.  And you don't need to add a ReadMe.md, but if you do point it to your Github pages blog.&lt;/p&gt;
&lt;h3&gt;Add Github as a remote repository&lt;/h3&gt;
&lt;p&gt;Now we can add Github as a remote repository.  We will push changes when we're satisfied with them.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;git remote add origin https://github.com/danlmarmot/blog.git
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Push the current changes.  You'll need to do this longform command with the "-u origin master" for this very first push, by the way.   Later commits you can just do "git push origin master"&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;git push -u origin master
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Push to Github&lt;/h3&gt;
&lt;p&gt;This part's easy, and this is what you need to do to update your blog.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;make github
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And then view it on Github:  &lt;a href="https://danlmarmot.github.io/blog/"&gt;https://danlmarmot.github.io/blog/&lt;/a&gt;.  Note that it might take up to ten minutes for the blog to show up.&lt;/p&gt;
&lt;p&gt;If you haven't used Git much, a good way to think of this pushing to Github as nothing more than sending updates to Github--don't think of Github as an authoritative source for your blog or some old-school master source code control server.  You're just telling Github that you're pushing new static content to it, generated on your own machine.  The real content is kept both on your machine and Github in the master branch.&lt;/p&gt;
&lt;p&gt;As for the gh-pages branch, you can somewhat ignore it.  It's almost a build artifact, rather than a real source code/content branch that you directly manipulate.&lt;/p&gt;
&lt;h3&gt;Lastly, a few notes on where this leaves your repository.&lt;/h3&gt;
&lt;p&gt;When you do this, you'll be left on your master branch, and not the gh-pages branch.  In Github, you'll have two separate branches with no common ancestor node, which looks kind of weird but is fine.
Github has a set of instructions at https://pages.github.com, but to be honest you don't ever need to go there--you can do everything from the command line once you make your Github repo.&lt;/p&gt;
&lt;p&gt;That's all for now.&lt;/p&gt;</summary><category term="pelican"></category></entry><entry><title>First Post!</title><link href="https://danlmarmot.github.io/blog/2014/08/03/my-first-post/" rel="alternate"></link><updated>2014-08-03T12:50:00-07:00</updated><author><name>Dan McKean</name></author><id>tag:danlmarmot.github.io,2014-08-03:blog/2014/08/03/my-first-post/</id><summary type="html">&lt;h1&gt;Hey, an initial blog post.&lt;/h1&gt;
&lt;p&gt;Just getting started.&lt;/p&gt;</summary><category term="fun"></category></entry></feed>